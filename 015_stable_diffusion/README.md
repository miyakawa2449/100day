# 高機能 画像スタイル変換 Streamlitアプリ

## 概要

このPythonスクリプトは、Streamlitを使用して構築されたウェブアプリケーションです。ローカル環境で動作しているStable Diffusion Web UIのAPIと連携し、アップロードした画像を指定した様々な画風（例: 水彩画風、ドラゴンボール風、油絵風など）に高品質に変換します。ユーザーは直感的なGUIを通じて、スタイル選択、プロンプト調整、詳細パラメータ設定を行うことができます。

## 主な機能

-   **画像アップロード:** ローカルから画像ファイル（PNG, JPG, WEBPなど）をアップロード。
-   **多彩なスタイル変換:**
    -   水彩画風
    -   ドラゴンボール風 (対応LoRAが必要)
    -   油絵風
    -   アニメスケッチ風
    -   写真風リアリスティック
    -   サイバーパンク風
    -   (今後さらにスタイル追加可能)
-   **プリセット機能:** スタイルを選択すると、推奨される基本プロンプト、ネガティブプロンプトの接尾辞、Denoising Strength、ステップ数、CFGスケールなどが自動的に設定されます。
-   **プロンプト編集:** 自動設定されたプロンプトをベースに、ユーザーが自由に追加・編集可能。
    -   被写体の具体的な説明の入力。
    -   基本プロンプトの編集。
    -   ネガティブプロンプトの編集。
-   **LoRA対応:** 特定のスタイル（例: ドラゴンボール風）でLoRAモデルを利用するための入力欄を提供（LoRAファイル名、トリガーワード、重み）。
-   **詳細パラメータ調整:**
    -   ステップ数 (Steps)
    -   CFGスケール (CFG Scale)
    -   シード値 (Seed)
    -   サンプラー (Sampler)
    -   Denoising Strength (スタイルの強さ)
-   **日本語ヘルプ:** 各パラメータやサンプラーの選択肢に日本語での説明（ツールチップ）を表示。
-   **リアルタイムプレビュー:** 元画像と生成された画像（または生成中のプレースホルダー）を横並びで表示し、比較が容易。
-   **画像ダウンロード:** 生成された画像をPNG形式でダウンロード可能（ファイル名にスタイル情報を含む）。
-   **状態管理の安定化:** Streamlitのセッションステートと `on_change` コールバックを活用し、スムーズな操作感と安定した動作を実現。

## 必要なもの (Prerequisites)

-   **Python:** 3.8以上 (開発時: Python 3.10.x)
-   **Stable Diffusion Web UI:** [AUTOMATIC1111版](https://github.com/AUTOMATIC1111/stable-diffusion-webui) などのAPI機能を持つWeb UIがローカルマシンにインストールされ、正常に動作していること。
-   **Web UIのAPI有効化:** Stable Diffusion Web UIが `--api` コマンドライン引数付きで起動されていること。
-   **必要なPythonライブラリ:**
    -   `streamlit`
    -   `requests`
    -   `Pillow`
-   **(オプション) LoRAモデル:** 特定の画風（例: ドラゴンボール風）を高品質に再現するためには、対応するLoRAモデルが必要です。LoRAモデルは、Stable Diffusion Web UIの `models/Lora` ディレクトリに配置してください。スクリプト内の `STYLES` 定義で推奨LoRAファイル名を指定できます。

## セットアップ (Setup)

1.  **スクリプトをダウンロード:**
    ```bash
    git clone [https://github.com/miyakawa2449/100day.git/tree/main/015_Stable_diffusion](https://github.com/miyakawa2449/100day.git/tree/main/015_Stable_diffusion)
    cd 100day/015_stable_diffusion 
    ```
    (上記は例です。あなたのリポジトリ構成に合わせてパスを調整してください。スクリプトファイル名は `streamlit_app.py` や `app.py` などになっていると想定しています。)

2.  **Python仮想環境の作成と有効化 (強く推奨):**
    プロジェクトディレクトリのルートで以下のコマンドを実行します。
    ```bash
    python -m venv venv
    ```
    仮想環境を有効化します:
    -   Windows (PowerShell):
        ```powershell
        .\venv\Scripts\Activate.ps1
        ```
        (実行ポリシーのエラーが出る場合は `Set-ExecutionPolicy RemoteSigned -Scope Process` を試してください)
    -   Windows (コマンドプロンプト):
        ```bash
        .\venv\Scripts\activate.bat
        ```
    -   macOS / Linux:
        ```bash
        source venv/bin/activate
        ```

3.  **必要なライブラリのインストール:**
    仮想環境が有効化された状態で、以下のコマンドを実行します。（`requirements.txt` があればそれを使用）
    ```bash
    pip install streamlit requests Pillow
    ```
    もし `requirements.txt` ファイルを作成する場合は、以下の内容で作成してください:
    ```txt
    streamlit
    requests
    Pillow
    ```
    そして `pip install -r requirements.txt` を実行します。

## 使い方 (Usage)

1.  **Stable Diffusion Web UIの起動:**
    お使いのStable Diffusion Web UIを `--api` オプションを付けて起動してください。起動時にターミナルに表示されるURLとポート番号（例: `http://127.0.0.1:7860`）を控えておきます。

2.  **スクリプトの設定確認:**
    Streamlitアプリのスクリプトファイル（例: `streamlit_app.py`）を開き、冒頭にある `API_URL` 定数が、手順1で確認したWeb UIのURLおよびポート番号と一致しているか確認・編集してください。
    ```python
    API_URL = "[http://127.0.0.1:7860](http://127.0.0.1:7860)"  # ご自身の環境に合わせて変更
    ```

3.  **Streamlitアプリの起動:**
    ターミナルで、スクリプトファイルがあるディレクトリに移動し、以下のコマンドを実行します。
    ```bash
    streamlit run streamlit_app.py
    ```
    (スクリプトのファイル名に合わせてください)

4.  **ブラウザでの操作:**
    コマンド実行後、自動的にウェブブラウザが起動し、アプリのUIが表示されます。
    -   **1. 画像をアップロード:** 変換したい画像ファイルを選択します。
    -   **プレビューエリア:** アップロードした元画像と、変換後の画像（初期状態ではプレースホルダー）が横並びで表示されます。
    -   **2. スタイルとプロンプトを設定:**
        -   「適用するスタイル」ドロップダウンから希望の画風を選択します。
        -   「被写体の説明」や「基本プロンプト」「ネガティブプロンプト」を編集します。スタイル選択時に推奨値が自動入力されます。
        -   必要に応じて「Denoising Strength」や、LoRA関連情報（スタイルがLoRAを推奨する場合）を入力・調整します。
    -   **サイドバー:** 「ステップ数」「CFGスケール」「シード値」「サンプラー」などの詳細パラメータを調整できます。各項目には日本語の説明が付いています。
    -   **3. 変換実行:** 「🎨 スタイル変換実行！」ボタンをクリックすると、画像生成が開始されます。処理中はスピナーが表示されます。
    -   **結果確認とダウンロード:** 処理が完了すると、プレビューエリアに生成された画像が表示され、「画像をダウンロード (PNG)」ボタンから保存できます。

## 注意点

-   本アプリを実行する前に、Stable Diffusion Web UIが起動しており、API機能が有効になっていることを必ず確認してください。
-   Web UIのポート番号がスクリプト内の `API_URL` と一致しているか確認してください。
-   特定のスタイルで高品質な結果を得るには、適切なLoRAモデルを事前に `models/Lora` ディレクトリに準備し、正しいLoRAファイル名とトリガーワードを指定する必要があります。
-   入力画像の解像度やステップ数によっては、処理に時間がかかったり、多くのVRAM（GPUメモリ）を消費する可能性があります。
-   万が一エラーが発生した場合は、Streamlitアプリ上のエラーメッセージと、Stable Diffusion Web UIのコンソールに表示されるエラーメッセージを合わせて確認してください。

## 今後の展望 (例)

-   対応スタイルのさらなる拡充と、プリセットの質の向上。
-   LoRAモデルの動的読み込みと選択機能。
-   `txt2img` 機能の追加。
-   バッチ処理機能（複数画像の一括変換）。
-   生成履歴の保存と再利用機能。

## ライセンス

このプロジェクトは [MIT License] の下で公開されています。

---