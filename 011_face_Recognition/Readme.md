# 100日チャレンジ - Day 11: 顔認識システムの改善（エラーハンドリング強化と特徴量拡張）

## 概要

このプロジェクトは、PythonとOpenCV、dlibライブラリを使用して顔認識システムを構築する100日チャレンジの一部です。
11日目では、昨日の顔認識システムをベースに、以下の2点を主な目的として改善を行いました。

1.  **エラーハンドリングの強化**: プログラムの安定性を高め、予期せぬエラーによる中断を防ぐ。
2.  **特徴量の拡張**: 既存の幾何学的特徴量に加え、新たな特徴量を追加し、認識精度の向上を目指す基礎を固める。

## 今日の主な変更点

### 1. エラーハンドリングの強化

プログラム全体の堅牢性を向上させるため、以下の箇所でエラーハンドリング処理を追加・強化しました。

* **初期化処理**:
    * OpenCVによるカメラデバイスのオープン失敗時。
    * dlibの顔検出器およびランドマーク予測モデルのファイル読み込み・初期化失敗時。
* **データベース操作**:
    * データベース接続、テーブル作成、データの挿入・選択など、`sqlite3` を利用する全てのデータベース操作において、`sqlite3.Error` を捕捉し、エラー発生時にもプログラムがクラッシュしにくいようにしました。
    * `finally`句を使用して、データベース接続が確実にクローズされるようにしました。
* **メインループ内の処理**:
    * カメラからのフレーム取得失敗時。
    * フレームのグレースケール変換や顔検出処理でのエラー。
    * 個々の顔のランドマーク検出や特徴量計算処理でのエラー。

これにより、ファイルが見つからない場合や、予期せぬデータに遭遇した場合でも、プログラムがより安定して動作し、問題発生時の原因究明が容易になることが期待されます。

### 2. 特徴量の拡張

顔の識別精度向上のため、従来の3つの特徴量に加え、新たに以下の5つの幾何学的特徴量をランドマークから計算するようにしました。

* **口の幅 (`mouth_width`)**: 口の両端の距離。
* **眉間の幅 (`inter_eyebrow_width`)**: 左右の眉頭の間の距離。
* **顔の高さ (`face_height`)**: 顎の先端から鼻梁までの距離。
* **上唇の厚み (`upper_lip_thickness`)**: 上唇の中心部分の縦の距離。
* **下唇の厚み (`lower_lip_thickness`)**: 下唇の中心部分の縦の距離。

この変更に伴い、以下の対応を行いました。

* **特徴量ベクトルの更新**: 認識時に使用する特徴量ベクトルに新しい特徴量を含めました。
* **データベース構造の互換性維持と更新**:
    * 新しい特徴量をJSON形式でデータベースに保存するようにしました。
    * データベースから特徴量を読み込む際、新しい特徴量キーが存在しない古いデータでもエラーにならないよう、`get()`メソッドのデフォルト値を利用して対応しました。
* **認識閾値 (`RECOGNITION_THRESHOLD`) の調整の必要性**:
    * 特徴量の種類と数が増えたため、顔と顔の「距離」の尺度が変わる可能性があります。そのため、この閾値は新しい特徴量セットに合わせて実験的に再調整する必要があります。（コード内では暫定的に `25.0` に設定）

**所感**:
ユーザー様からは「カメラに対して顔の向きをいろいろ変えても、登録した後はnameが出続けやすくなった気がします」とのフィードバックをいただきました。特徴量の追加により、顔の多様な状態に対するロバスト性（頑健性）が向上した可能性が示唆されます。

## 実行方法

1.  **必要なライブラリをインストールします**:
    ```bash
    pip install opencv-python dlib numpy
    ```
2.  **dlibの顔ランドマークモデルを準備します**:
    * `shape_predictor_68_face_landmarks.dat` というモデルファイルをダウンロードします。
    * dlibの公式サイトや他の信頼できるソースから入手可能です（例: [dlib.net model files](http://dlib.net/files/)）。
    * ダウンロードしたファイルを、上記のPythonスクリプトと同じディレクトリに配置してください。
3.  **スクリプトを実行します**:
    ```bash
    python your_script_name.py
    ```
    （`your_script_name.py` は保存したファイル名に置き換えてください）

## 操作方法

* **カメラウィンドウが表示されたら**:
    * **'r' キー**: 新しい人物を登録するか、既存の人物を選択してアクティブにします（コンソールに入力）。
    * **'s' キー**: 現在カメラに映っている最初の顔の特徴量を、アクティブな人物としてデータベースに保存します。
    * **'q' キー**: プログラムを終了します。

## 今後の課題 (Day 12以降の展望)

* **認識閾値の最適化**: 追加された特徴量に合わせて、`RECOGNITION_THRESHOLD` の値を実験的に調整し、最適な値を見つける。
* **特徴量のさらなる検討**: 他の幾何学的特徴量や、特徴量の正規化などを検討する。
* **深層学習ベースの特徴量抽出の導入準備**: FaceNetやArcFaceなどの深層学習モデルを利用した顔認識への移行を視野に入れる。