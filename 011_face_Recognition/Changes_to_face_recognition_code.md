# Face Memory System - 顔認識機能の追加

このドキュメントは、「Face Memory System」プロジェクトに顔認識機能を追加した際の主な変更点と使い方について説明します。
本機能は、事前にデータベースに登録された人物の顔特徴量（幾何学的特徴）と、カメラにリアルタイムで映った人物の顔特徴量を比較し、簡易的な個人識別を行います。

## 主な追加・変更点

このバージョンでは、データベースに保存された顔の特徴量を用いて、カメラに映った人物を簡易的に認識し、名前を表示する機能が追加されました。

* **`known_face_data` グローバル変数**:
    * データベースから読み込んだ登録済み人物の名前と、その人物の平均的な幾何学的特徴量ベクトルをメモリ上に保持します。
    * データ構造 (例): `{person_id: {"name": "お名前", "avg_features": numpy.array([特徴ベクトル])}}`

* **`RECOGNITION_THRESHOLD` グローバル変数**:
    * 顔を「既知の人物」として認識するための距離の閾値（しきいち）です。
    * この値よりも、カメラに映った顔の特徴量と登録済み人物の特徴量との間の計算された距離が小さい場合に、その人物として認識されます。この値は実験的な調整が必要です。

* **`load_known_faces_from_db()` 関数**:
    * プログラム起動時、および新規人物登録時や特徴量保存時に呼び出されます。
    * データベースの `persons` テーブルから人物IDと名前を取得します。
    * `face_features` テーブルから各人物の `geometric_features_json`（幾何学的特徴量をJSON形式で保存したもの）を読み込みます。
    * 各人物について保存されている複数の特徴量サンプルから、平均特徴量ベクトルを計算します（例: 目の距離、顔の幅、鼻の長さの平均値からなるベクトル）。
    * 計算結果を `known_face_data` 変数に格納し、リアルタイム認識処理で使用できるようにします。

* **`recognize_face(current_features_vector)` 関数**:
    * カメラからリアルタイムに計算された現在の顔の幾何学的特徴量ベクトルを受け取ります。
    * `known_face_data` に保持されている全ての登録済み人物の平均特徴量ベクトルとの間でユークリッド距離を計算します。
    * 最も距離が小さい（最も似ている可能性が高い）人物を探します。
    * その最小距離が `RECOGNITION_THRESHOLD` 未満であれば、該当する人物の名前と計算された距離を返します。そうでなければ "Unknown" （不明）と距離を返します。

* **メインループ内の処理の変更**:
    * 顔検出後、ランドマークから幾何学的特徴量を計算し、それを元に認識用の特徴量ベクトル (`current_feature_vector_for_recognition`) を作成します。
    * 作成したベクトルを `recognize_face()` 関数に渡し、認識結果（名前と距離）を取得します。
    * 取得した名前と距離を、OpenCVの `cv2.putText()` を使ってカメラ映像中の検出された顔の近くに表示します。

* **認識データの動的更新**:
    * 新しい人物がデータベースに登録されたり、既存の人物の顔特徴量が追加で保存されたりした場合、`load_known_faces_from_db()` 関数が再度呼び出されます。これにより、認識に使用するデータが常に最新の状態に保たれます。

## 使い方

1.  **データ収集と登録 (非常に重要)**:
    * まず、認識させたい人物を複数名、プログラムの人物登録機能（デフォルトではキーボードの 'r' キー）を使ってデータベースに登録します。
    * 各人物について、顔がカメラにはっきりと映っている状態で、特徴量保存機能（デフォルトでは 's' キー）を使用します。この際、**顔の角度や表情を少しずつ変えながら、各人物について複数回（例えば5回～10回程度）**顔データを保存してください。
        * 多くのサンプルを多様な条件で登録することで、各人物の「平均特徴量」がより代表的なものとなり、認識の精度向上に繋がります。

2.  **プログラムの起動**:
    * Pythonスクリプトを実行します。
    * 起動時に、`load_known_faces_from_db()` 関数が自動的に呼び出され、データベースに保存されている人物情報と平均特徴量がメモリにロードされます。コンソールにロードされた登録済みの人数が表示されるはずです。

3.  **リアルタイム顔認識**:
    * カメラに顔を向けると、プログラムがリアルタイムで顔を検出し、その特徴量を計算します。
    * データベースに登録されている人物であれば、顔のバウンディングボックス（枠線）の近くにその人物の名前と、データベースの特徴量との計算上の距離（類似度を示す指標の一つ）が表示されます。
    * 登録されていない人物、または登録されていても特徴量の距離が設定した閾値 (`RECOGNITION_THRESHOLD`) より大きい場合は、"Unknown" と表示されます。

4.  **閾値 (`RECOGNITION_THRESHOLD`) の調整**:
    * コード内のグローバル変数 `RECOGNITION_THRESHOLD` の値を調整することで、認識の「厳しさ」を変更できます。
        * この値を **小さく** すると、特徴がより厳密に一致しないと同一人物として認識されなくなります（"Unknown" と表示されやすくなりますが、他人を誤って認識する可能性は減る傾向にあります）。
        * この値を **大きく** すると、多少特徴が異なっていても同一人物として認識されやすくなります（名前が表示されやすくなりますが、他人を誤って認識する可能性も増える傾向にあります）。
    * 適切な閾値は、登録する顔データの質や量、使用環境の照明条件などによって変わります。色々試して、ご自身の環境で最適な値を見つけてください。

## 注意点・今後の改善点

* **現在の認識精度について**:
    * 現在システムで使用している「幾何学的特徴量」（例: 目の距離、顔の幅、鼻の長さなど）のみに基づく顔認識は、顔の微妙な向きの変化、表情の違い、照明条件の変動などに影響を受けやすいという性質があります。そのため、このアプローチだけでは、常に高い精度で個人を識別するのは難しいのが実情です。
    * 多様な条件下で多くの顔サンプルを登録することで、ある程度の精度改善は見込めますが、このアプローチの根本的な限界を超えるものではありません。

* **推奨される今後の改善策**:
    * **深層学習ベースの特徴量抽出の導入**: 顔認識の精度を大幅に向上させるためには、FaceNet、ArcFace、VGGFaceといった事前学習済みの深層学習モデルを使用する方法が現在の主流技術です。これらのモデルは、顔画像から個人を識別するのに非常に強力な高次元の特徴量ベクトル（Embeddingと呼ばれます）を抽出できます。
    * このEmbeddingをデータベースに保存し、それを比較することで、より頑健で高精度な個人識別システムを構築することが可能になります。
    * これを導入する場合、データベースのテーブル設計も、このEmbeddingベクトルを効率的に保存できるように見直す必要があります（例: BLOB型で保存するか、ベクトルを数値のリストとしてTEXT型で保存するなど）。