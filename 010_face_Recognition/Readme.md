# 顔認識プログラム - README

このプロジェクトは、Pythonを使用して顔認識を行うプログラムです。OpenCV、dlib、SQLiteといった技術を活用し、リアルタイムでカメラから顔の特徴量を検出し、データベースに保存します。保存されたデータとカメラに映る顔を比較することで、登録済みの人物を認識する機能を有しています。

---

## 主な機能

本プログラムは以下の主要な機能を提供します。

1.  **顔検出とランドマークの取得**:
    dlibライブラリの顔検出器とランドマーク予測器（68点モデル）を使用して、カメラ映像から顔の位置を特定し、目、鼻、口、輪郭などの特徴点を精密に取得します。

2.  **幾何学的特徴量の計算**:
    取得した顔のランドマーク座標を基に、個人識別に利用可能な幾何学的特徴量（例：両目の間隔、顔の幅、鼻の長さなど）を計算します。

3.  **データベースへの特徴量保存**:
    計算された特徴量や、登録された人物の名前などの情報をSQLiteデータベースに永続的に保存します。これにより、プログラムを再起動しても過去のデータを利用できます。

4.  **顔認識処理**:
    データベースに保存されている登録済みの顔データ（平均化された特徴量）と、カメラでリアルタイムに検出・計算された顔データとを比較します。ユークリッド距離などを用いて最も特徴が近い人物を識別し、名前を表示します。

5.  **リアルタイム処理とインタラクティブ操作**:
    Webカメラからの映像をリアルタイムで処理し、結果を画面に表示します。キーボードからの入力により、人物の新規登録や特徴量の保存、プログラムの終了といった操作が可能です。

---

## 必要な環境

本プログラムを実行するためには、以下の環境が必要です。

* Python 3.7 以上
* 必要なPythonライブラリ:
    * OpenCV (`opencv-python`)
    * dlib
    * NumPy (`numpy`)
    * Matplotlib (`matplotlib`) - (主にデバッグや可視化用)
    * sqlite3 (Python標準ライブラリのため、通常追加インストールは不要)
    * json (Python標準ライブラリのため、通常追加インストールは不要)

---

## セットアップ手順

プログラムを実行する前に、以下の手順でセットアップを行ってください。

1.  **依存ライブラリのインストール**:
    ターミナルまたはコマンドプロンプトを開き、以下のコマンドを実行して必要なPythonライブラリをインストールします。
    ```bash
    pip install opencv-python dlib numpy matplotlib
    ```

2.  **dlib学習済みモデルのダウンロード**:
    顔のランドマーク検出には、dlibの学習済みモデルファイルが必要です。
    `shape_predictor_68_face_landmarks.dat` ファイルを[dlib公式サイトのこちらのリンク](http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2)からダウンロードしてください。
    ダウンロードしたファイルは `.bz2` 形式で圧縮されているため、解凍して `shape_predictor_68_face_landmarks.dat` ファイルを取得し、本プログラムの実行ファイルと同じプロジェクトディレクトリ内に配置してください。

3.  **データベースの初期化**:
    プログラムを初めて実行すると、`face_database.db` という名前のSQLiteデータベースファイルがプロジェクトディレクトリ内に自動的に作成され、必要なテーブルが初期化されます。特別な手動操作は不要です。

---

## 実行方法

1.  **プログラムの起動**:
    ターミナルまたはコマンドプロンプトでプロジェクトディレクトリに移動し、以下のコマンドを実行してプログラムを起動します。
    （`face_Rec.py` はご自身のファイル名に合わせてください。）
    ```bash
    python face_Rec.py
    ```

2.  **操作方法**:
    プログラムが起動すると、Webカメラの映像が表示され、以下のキー操作が可能になります。
    * `'q'` キー: プログラムを終了します。
    * `'s'` キー: 現在カメラに検出されている顔（通常は最初に検出された顔）の特徴量を、現在アクティブな人物としてデータベースに保存します。
    * `'r'` キー: 新しい人物をデータベースに登録します。コンソール（ターミナル）に名前の入力を求められます。登録後、その人物がアクティブユーザーとして設定されます。

---

## プログラムの主要な構成要素（関数）

本プログラムは、主に以下の関数によって構成されています。

* **`init_db()`**:
    SQLiteデータベース接続を初期化し、人物情報（`persons`テーブル）と顔特徴量（`face_features`テーブル）を保存するための2つのテーブルを（存在しない場合に）作成します。

* **`register_person_dialog()`**:
    ユーザーに新しい人物の名前の入力を促し、入力された名前を`persons`テーブルに登録します。登録に成功すると、その人物が「アクティブユーザー」（特徴量保存時の対象ユーザー）として設定されます。

* **`save_face_features_to_db()`**:
    現在アクティブなユーザーとして、カメラから検出された顔のランドマーク座標と計算された幾何学的特徴量を`face_features`テーブルに保存します。

* **`load_known_faces_from_db()`**:
    プログラム起動時や人物情報が更新された際に呼び出されます。データベースから登録済みの全人物の顔特徴量を読み込み、各人物の平均特徴量を計算して、顔認識処理のためのメモリ上のデータ（`known_face_data`）を準備・更新します。

* **`recognize_face()`**:
    カメラからリアルタイムに取得した現在の顔の特徴量ベクトルと、`load_known_faces_from_db()`によって準備された登録済み人物の平均特徴量ベクトル群とを比較します。最も特徴が近い人物を特定し、設定された閾値に基づいて認識結果（人物名または"Unknown"）を返します。

---

## 今後の改善ポイント

本プログラムは以下の点で改善の余地があります。

* **エラーハンドリングの強化**:
    カメラデバイスの接続失敗、データベース操作時の予期せぬエラー、ファイルアクセスエラーなどに対するエラー処理をより詳細に実装することで、プログラム全体の堅牢性を向上させることができます。

* **顔認識精度の向上**:
    * **特徴量の拡張**: 現在の幾何学的特徴量に加え、顔のテクスチャ情報や、より多くのランドマーク間の相対的な比率や角度などを特徴量として追加する。
    * **閾値の動的調整**: 環境光やカメラの特性に応じて認識閾値を自動調整する仕組みの導入。
    * **高度な認識モデルの導入**: FaceNet、ArcFaceなどの深層学習ベースの顔認証モデルを利用し、顔画像から高次元の特徴量ベクトル（Embedding）を抽出・比較することで、精度の大幅な向上が期待できます（この場合、DB設計や特徴量保存方法の変更も必要になります）。

* **ユーザーインターフェース（UI）の改善**:
    現在のコンソールベースの操作（人物登録など）や、OpenCVウィンドウ上のシンプルな情報表示を、より直感的に操作できるグラフィカルユーザーインターフェース（GUI）に変更する（例：Tkinter, PyQt, Kivyなどの利用）。

---

## 注意事項

* 本プログラムの実行には、コンピュータに接続されたWebカメラが必要です。
* dlibの学習済みモデルファイル (`shape_predictor_68_face_landmarks.dat`) がプログラムと同じディレクトリに存在しない場合、またはパスが正しくない場合、プログラムはエラーメッセージを出力して終了します。
* 顔認識の精度は、データベースに登録されている顔データの量と質（多様な角度、表情、照明条件下でのサンプル）、および`RECOGNITION_THRESHOLD`の調整に大きく依存します。

---

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細については、プロジェクト内の`LICENSE`ファイルをご確認ください。

---

## 作者

* Tsuyoshi

このプロジェクトに関するご質問、バグ報告、改善提案などがございましたら、本リポジトリのIssueセクションをご利用ください。